###############################
# Generic
###############################
noop:
  alias: noop
  sequence:
    delay: 00:00:00
detect_media:
  alias: Select media scene based on state
  sequence:
    - service_template: >
        {% if is_state('switch.tv_meubel_mediaplayer', 'on') %}
          script.select_media_kijken
        {% elif is_state('switch.tv_meubel_tv', 'on') %}
          script.select_tv_kijken
        {% elif is_state('switch.tv_meubel_receiver', 'on') %}
          script.select_radio_luisteren
        {% else %}
          script.select_geen
        {% endif %}
detect_mv:
  alias: Initiate MV automations based on state
  sequence:
    - wait_template: "{{ is_state('binary_sensor.sonoff_pow_status', 'on') }}"
      timeout: 00:00:30
    - service: automation.trigger
      entity_id: automation.mechanische_ventilatie
detect_lights:
  alias: Detect light scene based on state
  sequence:
    - wait_template: "{{ is_state('binary_sensor.sonoff_4ch_status', 'on') }}"
      timeout: 00:00:30
    - condition: state
      entity_id: binary_sensor.sonoff_4ch_status
      state: 'on'
    - service: automation.turn_off
      entity_id: automation.light_scene_select
    - service_template: >
        {% if is_state('light.tv_meubel_spruitje', 'on') %}
          script.select_lights_dim
        {% elif is_state('light.raam', 'on') %}
          script.select_lights_vacancy
        {% else %}
          script.select_lights_all_off
        {% endif %}
    - service: automation.turn_on
      entity_id: automation.light_scene_select

###############################
# RF
###############################
reset_rf:
  alias: Reset RF
  sequence:
    - wait_template: "{{ is_state('binary_sensor.sonoff_rf_bridge_status', 'on') }}"
      timeout: 00:00:30
    - service: mqtt.publish
      data:
        topic: "sonoff/rfbridge-1/rfin"
        payload: "------"

###############################
# Lights
###############################
all_lights_off:
  alias: All Lights Off
  sequence:
    - service: script.select_lights_all_off
    - service: homeassistant.turn_off
      entity_id: light.eettafel
    - condition: sun
      after: sunset
    - service: script.prepare_for_bed
    - service: switch.turn_on
      entity_id: switch.hal_lamp
    - delay: 00:00:05
    - service: switch.turn_on
      entity_id: switch.overloop_lamp
    - delay: 00:00:55
    - service: switch.turn_off
      entity_id: switch.hal_lamp

###############################
# Bedroom
###############################
prepare_for_bed:
  alias: Klaarmaken om naar bed te gaan
  sequence:
    - service: light.turn_on
      entity_id: light.slaapkamer_achterwand
    - delay: 00:45:00
    - service: light.turn_off
      entity_id: light.slaapkamer_achterwand
    - service: switch.turn_off
      entity_id: switch.overloop_lamp
tv_slaapkamer_aan:
  alias: TV slaapkamer aan
  sequence:
    - service: script.turn_off
      entity_id: script.prepare_for_bed
    - condition: state
      entity_id: sun.sun
      state: 'below_horizon'
    - service: light.turn_on
      entity_id: light.slaapkamer_achterwand
timer_tv_slaapkamer:
  alias: Timer TV Slaapkamer
  sequence:
    - condition: state
      entity_id: switch.tv_slaapkamer
      state: 'on'
    - delay: '00:30:00'
    - service: script.turn_off_tv_slaapkamer
toggle_tv_slaapkamer:
  alias: Toggle TV Slaapkamer
  sequence:
    - service_template: >
        {% if is_state('switch.tv_slaapkamer', 'off') %}
          switch.turn_on
        {% else %}
          script.turn_on
        {% endif %}
      data_template:
        entity_id: >
          {% if is_state('switch.tv_slaapkamer', 'off') %}
            switch.tv_slaapkamer
          {% else %}
            script.turn_off_tv_slaapkamer
          {% endif %}
turn_off_tv_slaapkamer:
  alias: Turn off TV Slaapkamer
  sequence:
    - service: media_player.turn_off
      entity_id: media_player.slaapkamer
    - service: light.turn_off
      entity_id: light.slaapkamer_achterwand
    - delay: 00:00:15
    - service: switch.turn_off
      entity_id: switch.tv_slaapkamer

###############################
# Media devices
###############################
shutdown_mediaplayer:
  alias: Shutdown Mediaplayer
  sequence:
    - condition: state
      entity_id: switch.tv_meubel_mediaplayer
      state: 'on'
    - service: media_player.turn_off
      entity_id: media_player.woonkamer
    - delay: 00:00:15
    - service: switch.turn_off
      entity_id: switch.tv_meubel_mediaplayer
shutdown_tv:
  alias: Shutdown TV
  sequence:
    - condition: state
      entity_id: switch.tv_meubel_tv
      state: 'on'
    - service: script.shutdown_mediaplayer
    - wait_template: "{{ is_state('switch.tv_meubel_mediaplayer', 'off') }}"
      timeout: 00:00:20
    - service: switch.turn_off
      entity_id: switch.tv_meubel_tv
shutdown_receiver:
  alias: Shutdown Receiver
  sequence:
    - condition: state
      entity_id: switch.tv_meubel_receiver
      state: 'on'
    - service: script.shutdown_tv
    - wait_template: "{{ is_state('switch.tv_meubel_tv', 'off') }}"
      timeout: 00:00:25
    - service: media_player.select_source
      data:
        entity_id: media_player.receiver
        source: 'TV'
    - delay: 00:00:05
    - service: switch.turn_off
      entity_id: switch.tv_meubel_receiver
powerup_receiver:
  alias: Setup Receiver when it's ready to be
  sequence:
    - service: switch.turn_on
      entity_id: switch.tv_meubel_receiver
powerup_tv:
  alias: Powerup TV
  sequence:
    - service: script.powerup_receiver
    - service: switch.turn_on
      entity_id: switch.tv_meubel_tv
powerup_mediaplayer:
  alias: Powerup Mediaplayer
  sequence:
    - service: script.powerup_tv

###############################
# Receiver
###############################
increase_volume:
  alias: Increase Volume
  sequence:
    - service: homeassistant.update_entity
      entity_id: media_player.receiver
    - condition: state
      entity_id: media_player.receiver
      state: 'home'
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.receiver
        volume_level: >
          {{ (states.media_player.receiver.attributes.volume_level | float + 0.025) | round(4) }}
decrease_volume:
  alias: Decrease Volume
  sequence:
    - service: homeassistant.update_entity
      entity_id: media_player.receiver
    - condition: state
      entity_id: media_player.receiver
      state: 'home'
    - service: media_player.volume_set
      data_template:
        entity_id: media_player.receiver
        volume_level: >
          {{ (states.media_player.receiver.attributes.volume_level | float - 0.025) | round(4) }}

###############################
# Media scenes
###############################
select_geen:
  alias: Select media scene Geen
  sequence:
    - service: input_select.select_option
      data:
        entity_id: input_select.media_scene
        option: 'Geen'
select_tv_kijken:
  alias: Select media scene TV kijken
  sequence:
    - service: input_select.select_option
      data:
        entity_id: input_select.media_scene
        option: 'TV kijken'
select_media_kijken:
  alias: Select media scene Media kijken
  sequence:
    - service: input_select.select_option
      data:
        entity_id: input_select.media_scene
        option: 'Media kijken'
select_radio_luisteren:
  alias: Select media scene Radio luisteren
  sequence:
    - service: input_select.select_option
      data:
        entity_id: input_select.media_scene
        option: 'Radio luisteren'
select_lights_regular:
  alias: Select Light Scene Regular
  sequence:
    - service: input_select.select_option
      data_template:
        entity_id: input_select.light_scene
        option: 'Normaal'
select_lights_dim:
  alias: Select Light Scene Dim
  sequence:
    - service: input_select.select_option
      data_template:
        entity_id: input_select.light_scene
        option: 'Zacht'
select_lights_very_dim:
  alias: Select Light Scene Very Dim
  sequence:
    - service: input_select.select_option
      data_template:
        entity_id: input_select.light_scene
        option: 'Erg Zacht'
select_lights_vacancy:
  alias: Select Light Scene Vacancy
  sequence:
    - service: input_select.select_option
      data_template:
        entity_id: input_select.light_scene
        option: 'Vakantie'
select_lights_all_off:
  alias: Select Light Scene All Off
  sequence:
    - service: input_select.select_option
      data_template:
        entity_id: input_select.light_scene
        option: 'Uit'
listen_radio:
  alias: Listen Radio
  sequence:
    - service: automation.turn_off
      entity_id: automation.turn_on_mediaplayer
    - service: automation.turn_on
      entity_id: automation.check_receiver_source
    - service: script.shutdown_tv
    - service: script.powerup_receiver
watch_tv:
  alias: Watch TV
  sequence:
    - service: automation.turn_off
      entity_id: automation.turn_on_mediaplayer
    - service: automation.turn_on
      entity_id: automation.check_receiver_source
    - service: script.shutdown_mediaplayer
    - wait_template: "{{ is_state('switch.tv_meubel_mediaplayer', 'off') }}"
      timeout: 00:00:10
    - service: script.powerup_tv
watch_media:
  alias: Watch Media
  sequence:
    - service: automation.turn_on
      entity_id: automation.turn_on_mediaplayer
    - service: automation.turn_on
      entity_id: automation.check_receiver_source
    - service: script.powerup_mediaplayer
all_media_off:
  alias: All Media Off
  sequence:
    - service: script.shutdown_receiver
all_off:
  alias: All Off
  sequence:
    - service: script.select_geen
    - service: script.all_lights_off

###############################
# Notifications
###############################
notify_admin:
  sequence:
    - condition: state
      entity_id: input_boolean.admin_notifications
      state: 'on'
    - service: notify.pushover_admin
      data_template:
        title: "Admin message"
        message: "{{ message }}"
notify_alert:
  sequence:
    - service: notify.pushover
      data_template:
        title: "Alert!!!"
        message: "{{ message }}"
        data:
          priority: 1

